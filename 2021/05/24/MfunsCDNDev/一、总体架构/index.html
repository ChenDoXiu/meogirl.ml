<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>一、总体架构 | ChenDoXiu'Blog</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.8.2/mermaid.min.js"></script><script>mermaid.initialize({
  startOnLoad: true
  , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><script async="" data-ad-client="ca-pub-2710993749840463" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"> </script><meta name="generator" content="Hexo 5.4.0"></head><body><header><nav><a href="/">首页</a><a href="/archives/">归档</a><a href="/2021/06/11/danmaku/Mfuns弹幕手册/">弹幕文档</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2021-05-24T00:00:00.000Z" id="date"> 2021-05-24</time></span><br><span>updated:<time datetime="2021-07-02T05:42:41.311Z" id="updated"> 2021-07-02</time></span><br><span id="busuanzi_container_page_pv" style="display:none">Page visited&nbsp;<span id="busuanzi_value_page_pv"></span><span>&nbsp;times</span></span></div><h1>一、总体架构</h1><hr></div><div id="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>此项目整体上分为两个部分，中心节点和子节点</p>
<p>中心节点在整个网络中仅存在一个，分布式节点在网络上可以有无数个</p>
<h2 id="中心节点"><a href="#中心节点" class="headerlink" title="中心节点"></a>中心节点</h2><p>中心节点是整个网络的心脏，主要负责以下事务</p>
<h3 id="子节点的注册与管理"><a href="#子节点的注册与管理" class="headerlink" title="子节点的注册与管理"></a>子节点的注册与管理</h3><p>为了网络安全，所有的子节点，必须在中心节点注册才能加入网络。</p>
<p>中心节点会开放一个网络服务器，由用户提交一份网络的测速单，主站的 uid，由网络的管理员进行审核，审核通过后，在中心节点注册一个子节点的账号，并且将账号信息以私信的方式发送给注册者</p>
<h3 id="子节点的信任度管理"><a href="#子节点的信任度管理" class="headerlink" title="子节点的信任度管理"></a>子节点的信任度管理</h3><p>为了保证数据安全，在子节点间，实行一套信任度系统。中心节点会将子节点根据的信任度，划分不同的等级，不同的等级有不同的权限</p>
<p>任何新加入的子节点，初始的信任度为0</p>
<p>信任度上不封顶</p>
<h4 id="以下情况可以增加信任度"><a href="#以下情况可以增加信任度" class="headerlink" title="以下情况可以增加信任度"></a>以下情况可以增加信任度</h4><ol>
<li>子节点长时间稳定在线</li>
<li>子节点带宽速度满足要求</li>
<li>子节点网络延迟较低</li>
<li>待添加</li>
</ol>
<h4 id="以下情况会降低信任度"><a href="#以下情况会降低信任度" class="headerlink" title="以下情况会降低信任度"></a>以下情况会降低信任度</h4><ol>
<li>子节点在线时长不稳定</li>
<li>文件存在损坏</li>
<li>延迟高，速度慢</li>
</ol>
<h4 id="以下情况会被永久封禁"><a href="#以下情况会被永久封禁" class="headerlink" title="以下情况会被永久封禁"></a>以下情况会被永久封禁</h4><ol>
<li>恶意攻击其他节点</li>
<li>故意传播错误的文件</li>
</ol>
<h4 id="临时不稳定名单"><a href="#临时不稳定名单" class="headerlink" title="临时不稳定名单"></a>临时不稳定名单</h4><p>如果一个节点在短时间内非常不稳定，将会被加入到这个名单内，暂时不能访问，直到其恢复正常</p>
<h3 id="文件的存储及分发"><a href="#文件的存储及分发" class="headerlink" title="文件的存储及分发"></a>文件的存储及分发</h3><p>中心节点会开放一个接口，用于文件的上传，文件上传需要权限认证，目前仅会给主站认证</p>
<h4 id="文件上传的步骤"><a href="#文件上传的步骤" class="headerlink" title="文件上传的步骤"></a>文件上传的步骤</h4><ol>
<li>主站用户在网站的前台上传视频或者图片</li>
<li>图片上传至主站后，主站再携带认证信息将文件转存至中心节点</li>
<li>中心节点计算文件的 md5 信息，保存至数据库</li>
<li>对于大文件，则会按照一定的大小进行分块md5存储</li>
<li>（如果云存储存在）文件将同步到云存储，永久性保存</li>
<li>中心节点开始分发文件</li>
<li>子节点开始互相同步文件</li>
</ol>
<h3 id="子节点文件验证"><a href="#子节点文件验证" class="headerlink" title="子节点文件验证"></a>子节点文件验证</h3><p>子节点的在同步文件的过程中，每同步完成一个文件，就会计算该文件的md5并上传至服务器验证，服务器也会保存验证结果，并定期进行清算</p>
<p>如果清算发现某个节点的错误率比较高，将会降低信任度</p>
<h3 id="文件路由"><a href="#文件路由" class="headerlink" title="文件路由"></a>文件路由</h3><p>路由一个文件，会出现4种情况</p>
<p>第一种：文件存在，并且已同步至各分布式节点<br>这种情况下，系统会将路由到分布式节点中，客户端直接读取分布式节点资源</p>
<p>第二种：文件存在，已经上传至云存储，但文件还未同步分布式节点，此情况，中心节点会路由到云存储</p>
<p>第三种：文件存在，并且未上传至云存储，也未分发到分布式节点，这时中心节点直接返回文件</p>
<p>第四种：文件不存在，中心返回404</p>
<p>路由的方式存在以下两种</p>
<h4 id="GET-请求-302-跳转"><a href="#GET-请求-302-跳转" class="headerlink" title="GET 请求 302 跳转"></a>GET 请求 302 跳转</h4><p>中心节点会开放一个接收 GET 请求的 HTTP/HTTPS 节点，将文件的特征拼接在 URL 中，如果请求的文件存在，将会302重定向到真实的文件地址</p>
<h4 id="GET、POST请求返回真实文件json"><a href="#GET、POST请求返回真实文件json" class="headerlink" title="GET、POST请求返回真实文件json"></a>GET、POST请求返回真实文件json</h4><p>服务器返回一个带有真实地址的JSON文件，客户端读取地址，下载真实文件</p>
<h3 id="热门文件分发"><a href="#热门文件分发" class="headerlink" title="热门文件分发"></a>热门文件分发</h3><p>热门文件的计算方式：</p>
<p>热度 = 基础热度 + （文件短期内访问次数x每次访问增加的热度基数）</p>
<p> 基础热度：新发布的文件其基础热度会比较高</p>
<h3 id="SSL证书申请"><a href="#SSL证书申请" class="headerlink" title="SSL证书申请"></a>SSL证书申请</h3><p>中心节点会根据子节点IP地址，为每一个子节点绑定一个二级域名，并为其申请SSL证书</p>
<h2 id="子节点"><a href="#子节点" class="headerlink" title="子节点"></a>子节点</h2><p>相比中心节点，子节点的任务则少一些<br>任务主要如下</p>
<h3 id="定期扫描中心节点提供的文件清单"><a href="#定期扫描中心节点提供的文件清单" class="headerlink" title="定期扫描中心节点提供的文件清单"></a>定期扫描中心节点提供的文件清单</h3><p>子节点会按时扫描中心节点提供的热门文件清单，按照热度依次下载文件</p>
<p>子节点会优先从其他子节点下载文件如果没有子节点可供下载，会从中心节点下载</p>
<p>子节点在下载完成一个文件之后，会计算文件的md5，发送到中心服务器进行验证，如果验证未通过，将会重新下载</p>
<h3 id="给其他子节点提供一份自己的文件清单"><a href="#给其他子节点提供一份自己的文件清单" class="headerlink" title="给其他子节点提供一份自己的文件清单"></a>给其他子节点提供一份自己的文件清单</h3><p>子节点会遍历自身缓存池内的所有文件，在内存中保存一份清单，提供给其他节点</p>
<h3 id="开放HTTP-HTTPS端口给浏览器-客户端提供文件"><a href="#开放HTTP-HTTPS端口给浏览器-客户端提供文件" class="headerlink" title="开放HTTP/HTTPS端口给浏览器/客户端提供文件"></a>开放HTTP/HTTPS端口给浏览器/客户端提供文件</h3><p>子节点会优先尝试80/443端口，如果端口无法使用，会从1024以上的端口中选择能用的端口</p>
<h3 id="从中心节点下载SSL证书"><a href="#从中心节点下载SSL证书" class="headerlink" title="从中心节点下载SSL证书"></a>从中心节点下载SSL证书</h3><p>由于新版 Chrome 会默认拒绝连接HTTP协议的服务器，造成图片无法加载，所以必须使用HTTPS才能保证服务器的正常运行</p>
<h3 id="定期发送心跳请求"><a href="#定期发送心跳请求" class="headerlink" title="定期发送心跳请求"></a>定期发送心跳请求</h3><p>子节点会每隔一段时间向中心节点发送一个HTTP请求以保证节点在线，并且会在请求中加入发送时间戳，来计算延迟</p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/06/11/danmaku/Mfuns%E5%BC%B9%E5%B9%95%E6%89%8B%E5%86%8C/">← Prev Mfuns高级弹幕手册</a><span style="color: #fe2"> | </span><a href="/2021/05/23/MfunsCDN/%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0/">（1）Mfuns分布式CDN概述 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: '6SB5OsciMQ5tkvTl0GyiUWmb-gzGzoHsz'
 , appKey: 'DcEF8qgxKFUIhiYsvfNOhE2x'
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.ChenDoXiu</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">9</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">7</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">5</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E5%BF%83%E8%8A%82%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">中心节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%8E%E7%AE%A1%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">子节点的注册与管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E4%BF%A1%E4%BB%BB%E5%BA%A6%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">子节点的信任度管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%83%85%E5%86%B5%E5%8F%AF%E4%BB%A5%E5%A2%9E%E5%8A%A0%E4%BF%A1%E4%BB%BB%E5%BA%A6"><span class="toc-number">2.2.1.</span> <span class="toc-text">以下情况可以增加信任度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%83%85%E5%86%B5%E4%BC%9A%E9%99%8D%E4%BD%8E%E4%BF%A1%E4%BB%BB%E5%BA%A6"><span class="toc-number">2.2.2.</span> <span class="toc-text">以下情况会降低信任度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%83%85%E5%86%B5%E4%BC%9A%E8%A2%AB%E6%B0%B8%E4%B9%85%E5%B0%81%E7%A6%81"><span class="toc-number">2.2.3.</span> <span class="toc-text">以下情况会被永久封禁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E4%B8%8D%E7%A8%B3%E5%AE%9A%E5%90%8D%E5%8D%95"><span class="toc-number">2.2.4.</span> <span class="toc-text">临时不稳定名单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E5%AD%98%E5%82%A8%E5%8F%8A%E5%88%86%E5%8F%91"><span class="toc-number">2.3.</span> <span class="toc-text">文件的存储及分发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">文件上传的步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9%E6%96%87%E4%BB%B6%E9%AA%8C%E8%AF%81"><span class="toc-number">2.4.</span> <span class="toc-text">子节点文件验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%B7%AF%E7%94%B1"><span class="toc-number">2.5.</span> <span class="toc-text">文件路由</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET-%E8%AF%B7%E6%B1%82-302-%E8%B7%B3%E8%BD%AC"><span class="toc-number">2.5.1.</span> <span class="toc-text">GET 请求 302 跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E3%80%81POST%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E%E7%9C%9F%E5%AE%9E%E6%96%87%E4%BB%B6json"><span class="toc-number">2.5.2.</span> <span class="toc-text">GET、POST请求返回真实文件json</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E9%97%A8%E6%96%87%E4%BB%B6%E5%88%86%E5%8F%91"><span class="toc-number">2.6.</span> <span class="toc-text">热门文件分发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">2.7.</span> <span class="toc-text">SSL证书申请</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">子节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%9C%9F%E6%89%AB%E6%8F%8F%E4%B8%AD%E5%BF%83%E8%8A%82%E7%82%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95"><span class="toc-number">3.1.</span> <span class="toc-text">定期扫描中心节点提供的文件清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E5%85%B6%E4%BB%96%E5%AD%90%E8%8A%82%E7%82%B9%E6%8F%90%E4%BE%9B%E4%B8%80%E4%BB%BD%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95"><span class="toc-number">3.2.</span> <span class="toc-text">给其他子节点提供一份自己的文件清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%94%BEHTTP-HTTPS%E7%AB%AF%E5%8F%A3%E7%BB%99%E6%B5%8F%E8%A7%88%E5%99%A8-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%90%E4%BE%9B%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">开放HTTP&#x2F;HTTPS端口给浏览器&#x2F;客户端提供文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E4%B8%AD%E5%BF%83%E8%8A%82%E7%82%B9%E4%B8%8B%E8%BD%BDSSL%E8%AF%81%E4%B9%A6"><span class="toc-number">3.4.</span> <span class="toc-text">从中心节点下载SSL证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%9C%9F%E5%8F%91%E9%80%81%E5%BF%83%E8%B7%B3%E8%AF%B7%E6%B1%82"><span class="toc-number">3.5.</span> <span class="toc-text">定期发送心跳请求</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2021</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr><br><span id="busuanzi_container_site_pv" style="display:none">Site visited&nbsp;<span id="busuanzi_value_site_pv"></span><span>&nbsp;times</span></span><br><span id="busuanzi_container_site_uv" style="display:none">Total&nbsp;<span id="busuanzi_value_site_uv"></span><span>&nbsp;people</span></span></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>